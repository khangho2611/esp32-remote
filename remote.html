<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const HOST_WSS = "wss://824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud:8884/mqtt";
const USER = "khangho";
const PASS = "Khangho@123";

const deviceId = new URL(location).searchParams.get("id") || "esp32-001";
const CMD = `ctrl/${deviceId}/cmd`;
const ACK = `ctrl/${deviceId}/ack`;

const log=(s)=>{const el=log.el||(log.el=document.getElementById('log')); el.textContent+=s+"\n"; el.scrollTop=el.scrollHeight;}
const info=(s)=>document.getElementById('info').textContent=s;

const client = mqtt.connect(HOST_WSS, {
  username: USER,
  password: PASS,
  clientId: "web-" + Math.random().toString(16).slice(2),
  clean: true,
  protocolVersion: 4,      // MQTT 3.1.1
  connectTimeout: 10000,
  reconnectPeriod: 2000,
});

client.on('connect', ()=>{
  info('Connected');
  client.subscribe(ACK, err => { if(err) log('sub error: '+err); else log('sub '+ACK); });
});

client.on('message', (t,m)=> log(`${t}: ${m}`));
client.on('error', e=>{ info('MQTT error'); log(e?.message || e.toString()); });
client.on('close', ()=> log('closed'));
client.on('reconnect', ()=> log('reconnect...'));

document.getElementById('on').onclick  = ()=> client.publish(CMD, "ON");
document.getElementById('off').onclick = ()=> client.publish(CMD, "OFF");
</script>
