<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32 Sensors · DHT11 · MQ-2 · Water</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{color-scheme:dark}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:18px; backdrop-filter:blur(8px)}
  .metric{font-size:clamp(28px,7vw,52px);line-height:1;font-weight:900}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .dot{width:.6rem;height:.6rem;border-radius:999px}
  .bar{height:.7rem;border-radius:.7rem;transition:width .25s ease}
</style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="max-w-6xl mx-auto p-6 space-y-6">

  <!-- HEADER -->
  <header class="flex items-center justify-between gap-3">
    <h1 class="text-3xl md:text-4xl font-black tracking-tight">
      ESP32 Sensors <span class="text-slate-400 font-semibold">/ DHT11 · MQ-2 · Water</span>
    </h1>
    <div id="badge" class="card flex items-center gap-2 py-2 px-3">
      <span id="dot" class="dot bg-slate-500"></span>
      <span id="state" class="text-sm">Disconnected</span>
      <span id="last" class="text-xs text-slate-400 ml-2 hidden">—</span>
    </div>
  </header>

  <!-- CONNECT -->
  <section class="card">
    <div class="grid md:grid-cols-6 gap-3">
      <div class="md:col-span-3">
        <label class="text-xs text-slate-400">Broker (host)</label>
        <input id="host" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2"
               value="824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud">
      </div>
      <div>
        <label class="text-xs text-slate-400">Port</label>
        <input id="port" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="8884">
      </div>
      <div>
        <label class="text-xs text-slate-400">Path</label>
        <input id="path" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="/mqtt">
      </div>
      <div>
        <label class="text-xs text-slate-400">Topic</label>
        <input id="topic" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2"
               value="esp32/sensors">
      </div>
      <div>
        <label class="text-xs text-slate-400">Client ID</label>
        <div class="flex gap-2">
          <input id="cid" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2 mono">
          <button class="mt-1 px-3 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="randId()">Rand</button>
        </div>
      </div>
      <div>
        <label class="text-xs text-slate-400">Username</label>
        <input id="user" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="admin123">
      </div>
      <div>
        <label class="text-xs text-slate-400">Password</label>
        <input id="pass" type="password" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" placeholder="••••••••">
      </div>
      <div class="md:col-span-2 flex items-end gap-2">
        <input id="wss" class="flex-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2 mono" readonly>
        <button class="px-4 py-2 rounded-xl bg-emerald-400 text-black font-semibold hover:brightness-110" onclick="connect()">Connect</button>
        <button class="px-4 py-2 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
  </section>

  <!-- METRICS -->
  <section class="grid md:grid-cols-4 gap-4">
    <!-- MQ-2 -->
    <div class="card md:col-span-2">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-sky-300">MQ-2 Smoke</div>
        <span id="mq2Raw" class="text-xs mono px-2 py-1 rounded-full bg-sky-400/10 border border-sky-400/20">raw: --</span>
      </div>
      <div class="mt-4">
        <div id="mq2Pct" class="metric">--%</div>
        <div class="mt-3 bg-slate-800/60 rounded-xl overflow-hidden">
          <div id="mq2Bar" class="bar bg-gradient-to-r from-emerald-400 via-yellow-400 to-rose-500" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Temp -->
    <div class="card">
      <div class="font-semibold text-amber-300">Temperature</div>
      <div id="tempVal" class="mt-4 metric">--°C</div>
      <div class="text-xs text-slate-400 mt-1">DHT11</div>
    </div>

    <!-- Humi -->
    <div class="card">
      <div class="font-semibold text-indigo-300">Humidity</div>
      <div id="humVal" class="mt-4 metric">--%</div>
      <div class="text-xs text-slate-400 mt-1">DHT11</div>
    </div>

    <!-- WATER CARD -->
    <div class="card md:col-span-2">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-teal-300">Water sensor</div>
        <span class="text-xs text-slate-400">0 = KHÔ · 1 = CÓ NƯỚC</span>
      </div>
      <div class="mt-4 flex items-center gap-4">
        <div id="waterBadge" class="flex items-center gap-3 px-4 py-2 rounded-2xl border bg-slate-800/60 border-slate-700">
          <span id="waterDot" class="dot bg-slate-500"></span>
          <span id="waterText" class="font-semibold">--</span>
        </div>
        <div id="waterNote" class="text-slate-400 text-sm">Waiting data…</div>
      </div>
    </div>
  </section>

  <!-- CONSOLE -->
  <section class="card">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Console</div>
      <button class="px-3 py-1 rounded-lg bg-slate-100/10 hover:bg-slate-100/20" onclick="clearLog()">Clear</button>
    </div>
    <pre id="log" class="mono bg-slate-950/50 border border-slate-800 rounded-xl p-3 h-56 overflow-y-auto text-slate-300"></pre>
  </section>

</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const $ = id => document.getElementById(id);
function log(m){ const el=$('log'); el.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`; el.scrollTop=el.scrollHeight; }
function clearLog(){ $('log').textContent=''; }
function randId(){ $('cid').value='web-'+Math.random().toString(16).slice(2,8); }
function updateWSS(){ const host=$('host').value.trim(), port=$('port').value.trim()||'8884', path=$('path').value.trim()||'/mqtt'; $('wss').value = host?`wss://${host}:${port}${path}`:''; }
['host','port','path'].forEach(id=>$(id).addEventListener('input',updateWSS)); randId(); updateWSS();

let client=null;
function setState(s){ const dot=$('dot'), st=$('state'); dot.className='dot'; if(s==='connected'){dot.classList.add('bg-emerald-400');st.textContent='Connected'}else if(s==='connecting'){dot.classList.add('bg-amber-400');st.textContent='Connecting...'}else if(s==='error'){dot.classList.add('bg-rose-400');st.textContent='Error'}else{dot.classList.add('bg-slate-500');st.textContent='Disconnected'} }

function connect(){
  const host=$('host').value.trim(); if(!host){ alert('Nhập broker host'); return; }
  const url=`wss://${host}:${$('port').value.trim()||'8884'}${$('path').value.trim()||'/mqtt'}`;
  const opts={ clientId:$('cid').value.trim()||('web-'+Math.random().toString(16).slice(2,8)),
               username:$('user').value.trim()||undefined, password:$('pass').value||undefined,
               clean:true, reconnectPeriod:4000, connectTimeout:15000 };
  if(client){ try{client.end(true);}catch(e){} }
  setState('connecting'); log(`Connecting ${url} as ${opts.clientId}`);
  client=mqtt.connect(url,opts);

  client.on('connect', ()=>{
    setState('connected'); log('Connected');
    const topic=$('topic').value.trim()||'esp32/sensors';
    client.subscribe(topic,{qos:0},err=>log(err?('Subscribe error: '+err.message):('Subscribed: '+topic)));
  });
  client.on('message',(topic,p)=>{
    const text=new TextDecoder().decode(p);
    log(`<= ${topic}: ${text}`);
    try{ const d=JSON.parse(text); apply(d); }catch(e){}
  });
  client.on('reconnect', ()=>{ setState('connecting'); log('Reconnecting...'); });
  client.on('close', ()=>{ setState('disconnected'); log('Socket closed'); });
  client.on('error', e=>{ setState('error'); log('Error: '+(e?.message||e)); });
}
function disconnect(){ if(client){ client.end(true); setState('disconnected'); log('Disconnected'); } }

// === APPLY SENSOR DATA: {"t":..,"h":..,"mq2":..,"water":0|1} ===
// Mapping: 0 = DRY/ KHÔ, 1 = WET/ CÓ NƯỚC
function apply(d){
  const last=$('last'); last.classList.remove('hidden'); last.textContent='Last update: '+new Date().toLocaleTimeString();

  if(Number.isFinite(d.mq2)){
    const raw=Math.min(1023,Math.max(0,d.mq2));
    const pct=Math.round(raw/1023*100);
    $('mq2Raw').textContent='raw: '+raw;
    $('mq2Pct').textContent=pct+'%';
    $('mq2Bar').style.width=pct+'%';
  }
  if(Number.isFinite(d.t)) $('tempVal').textContent=d.t.toFixed(1)+'°C';
  if(Number.isFinite(d.h)) $('humVal').textContent=d.h.toFixed(0)+'%';
  if(typeof d.water!=='undefined'){
    const isWet=(d.water===1); // 1 = CÓ NƯỚC
    const dot=$('waterDot'), badge=$('waterBadge'), text=$('waterText'), note=$('waterNote');
    dot.className='dot '+(isWet?'bg-sky-400':'bg-emerald-400');
    badge.className='flex items-center gap-3 px-4 py-2 rounded-2xl border '+(isWet?'bg-sky-400/10 border-sky-400/25':'bg-emerald-400/10 border-emerald-400/25');
    text.textContent=isWet?'WET · CÓ NƯỚC':'DRY · KHÔ';
    note.textContent=isWet?'Trạng thái: có nước (water=1)':'Trạng thái: khô (water=0)';
  }
}
</script>
</body>
</html>
