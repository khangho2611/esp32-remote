<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 Sensor Dashboard — MQTT over WSS (TLS)</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com">function updatePreview(){
  const host = $('host').value.trim();
  const port = parseInt($('port').value.trim(),10)||8884;
  const path = $('path').value.trim()||'/mqtt';
  const url = host?`wss://${host}:${port}${path}`:'';
  const el = $('wssPreview'); if (el) el.value = url;
}
</script>
  <!-- MQTT.js CDN (browser build) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    .card { @apply rounded-2xl shadow-md p-5 bg-white; }
    .pill { @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm; }
    .badge { @apply inline-block rounded-full text-xs px-2 py-0.5; }
    .mono { font-variant-ligatures: none; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">ESP32 Sensor Dashboard</h1>
      <div id="connStatus" class="pill bg-slate-200 text-slate-700">
        <span class="w-2 h-2 rounded-full bg-slate-400" id="connDot"></span>
        <span id="connText">Disconnected</span>
      </div>
    </header>

    <!-- Connection Panel -->
    <section class="card mb-6">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Broker Host (WSS)</label>
          <input id="host" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud" value="824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud" />
        </div>
        <div>
          <label class="block text-sm font-medium">Port</label>
          <input id="port" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="8884" value="8884" />
        </div>
        <div>
          <label class="block text-sm font-medium">Path</label>
          <input id="path" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="/mqtt" value="/mqtt" />
        </div>
        <!-- TLS Websocket URL preview -->
        <div class="md:col-span-3">
          <label class="block text-sm font-medium">TLS Websocket URL (preview)</label>
          <input id="wssPreview" class="mt-1 w-full border rounded-xl px-3 py-2 mono" value="wss://824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud:8884/mqtt" readonly />
          <p class="text-xs text-slate-500 mt-1">Đây là URL mà trình duyệt sẽ kết nối qua WSS (TLS). Thay đổi Host/Port/Path ở trên sẽ cập nhật trường này.</p>
        </div>
        <div>
          <label class="block text-sm font-medium">Client ID</label>
          <input id="clientId" class="mt-1 w-full border rounded-xl px-3 py-2 mono" placeholder="web-esp32-xxxx" />
        </div>
        <div>
          <label class="block text-sm font-medium">Username</label>
          <input id="username" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="your-username" />
        </div>
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input id="password" type="password" class="mt-1 w-full border rounded-xl px-3 py-2" placeholder="••••••••" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Subscribe Topic</label>
          <input id="subTopic" class="mt-1 w-full border rounded-xl px-3 py-2 mono" placeholder="esp32/sensors" value="esp32/sensors" />
          <p class="text-xs text-slate-500 mt-1">ESP32 nên publish JSON 1 dòng vào topic này.</p>
        </div>
        <div class="flex items-end gap-3">
          <button id="btnConnect" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Connect</button>
          <button id="btnDisconnect" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Disconnect</button>
        </div>
      </div>
    </section>

    <!-- Sensor Cards -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">MQ-2 Smoke</h2>
          <span id="mq2RawBadge" class="badge bg-slate-200">raw: --</span>
        </div>
        <div class="mt-4">
          <div class="flex items-baseline gap-2">
            <div class="text-3xl font-bold" id="mq2Lvl">--%</div>
            <div class="text-sm text-slate-500" id="mq2Volt">-- V</div>
          </div>
          <div class="mt-3 h-3 bg-slate-200 rounded-full">
            <div id="mq2Bar" class="h-3 bg-rose-500 rounded-full" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Potentiometer</h2>
          <span id="potRawBadge" class="badge bg-slate-200">raw: --</span>
        </div>
        <div class="mt-4">
          <div class="flex items-baseline gap-2">
            <div class="text-3xl font-bold" id="potPct">--%</div>
            <div class="text-sm text-slate-500" id="potVolt">-- V</div>
          </div>
          <div class="mt-3 h-3 bg-slate-200 rounded-full">
            <div id="potBar" class="h-3 bg-sky-500 rounded-full" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Water Sensor</h2>
          <span id="waterMode" class="badge bg-indigo-100 text-indigo-700">mode: --</span>
        </div>
        <div class="mt-4" id="waterAnalog">
          <div class="flex items-baseline gap-2">
            <div class="text-3xl font-bold" id="waterPct">--%</div>
            <div class="text-sm text-slate-500" id="waterVolt">-- V</div>
          </div>
          <div class="mt-3 h-3 bg-slate-200 rounded-full">
            <div id="waterBar" class="h-3 bg-emerald-500 rounded-full" style="width:0%"></div>
          </div>
          <div class="mt-2 text-sm text-slate-500">raw: <span id="waterRaw">--</span></div>
        </div>
        <div class="mt-4 hidden" id="waterDigital">
          <div class="text-2xl font-bold" id="waterDO">--</div>
          <p class="text-sm text-slate-500">0/1 (tuỳ module đảo mức)</p>
        </div>
      </div>
    </section>

    <!-- Console -->
    <section class="card mt-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Console</h3>
        <button id="btnClear" class="text-sm px-3 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Clear</button>
      </div>
      <pre id="log" class="whitespace-pre-wrap text-sm bg-slate-50 border rounded-xl p-3 h-64 overflow-y-auto mono"></pre>
    </section>

    <footer class="text-xs text-slate-500 mt-8">
      Served as static site (GitHub Pages). Uses MQTT over WebSockets Secure (WSS) to connect directly to your broker. Ensure your broker supports WSS/TLS with a valid certificate.
    </footer>
  </div>

<script>
let client = null;
const $ = (id) => document.getElementById(id);
const log = (msg) => {
  const el = $('log');
  const time = new Date().toLocaleTimeString();
  el.textContent += `[${time}] ${msg}\n`;
  el.scrollTop = el.scrollHeight;
};

function setConnState(state) {
  const dot = $('connDot');
  const text = $('connText');
  const pill = $('connStatus');
  pill.classList.remove('bg-emerald-100','text-emerald-700','bg-amber-100','text-amber-700','bg-rose-100','text-rose-700','bg-slate-200');
  dot.classList.remove('bg-emerald-500','bg-amber-500','bg-rose-500','bg-slate-400');
  if (state === 'connected') {
    pill.classList.add('bg-emerald-100','text-emerald-700');
    dot.classList.add('bg-emerald-500');
    text.textContent = 'Connected';
  } else if (state === 'connecting') {
    pill.classList.add('bg-amber-100','text-amber-700');
    dot.classList.add('bg-amber-500');
    text.textContent = 'Connecting…';
  } else if (state === 'error') {
    pill.classList.add('bg-rose-100','text-rose-700');
    dot.classList.add('bg-rose-500');
    text.textContent = 'Error';
  } else {
    pill.classList.add('bg-slate-200');
    dot.classList.add('bg-slate-400');
    text.textContent = 'Disconnected';
  }
}

function connect() {
  updatePreview();
  const host = $('host').value.trim();
  const port = parseInt($('port').value.trim(), 10) || 8884;
  const path = $('path').value.trim() || '/mqtt';
  const clientId = ($('clientId').value.trim() || `web-${Math.random().toString(16).slice(2,8)}`);
  const username = $('username').value.trim();
  const password = $('password').value;
  const subTopic = $('subTopic').value.trim();

  if (!host) { alert('Please enter broker host'); return; }

  // Build WSS URL
  const url = `wss://${host}:${port}${path}`;
  log(`Connecting to ${url} as ${clientId} …`);
  setConnState('connecting');

  // Close old
  if (client) { try { client.end(true); } catch(e){} }

  // Connect
  client = mqtt.connect(url, {
    clientId,
    username: username || undefined,
    password: password || undefined,
    clean: true,
    reconnectPeriod: 4000,
    connectTimeout: 15_000,
  });

  client.on('connect', () => {
    setConnState('connected');
    log('Connected. Subscribing: ' + subTopic);
    if (subTopic) client.subscribe(subTopic, { qos: 0 }, (err) => {
      if (err) log('Subscribe error: ' + err.message);
    });
  });

  client.on('reconnect', () => setConnState('connecting'));
  client.on('close',     () => setConnState('disconnected'));
  client.on('end',       () => setConnState('disconnected'));
  client.on('error',     (err) => { setConnState('error'); log('Error: ' + err.message); });

  client.on('message', (topic, payload) => {
    const text = new TextDecoder().decode(payload);
    log(`← ${topic}: ${text}`);
    try {
      const data = JSON.parse(text);
      updateUI(data);
    } catch (e) {
      // ignore non-JSON
    }
  });
}

function updateUI(data) {
  // Expected JSON structure from your ESP32 code:
  // {
  //   "mq2":   {"raw":n, "v":x.xx, "lvl":p},
  //   "pot":   {"raw":n, "v":x.xx, "pct":p},
  //   "water": {"mode":"analog","raw":n,"v":x.xx,"pct":p}
  //            or {"mode":"digital","do":0|1}
  // }
  if (data.mq2) {
    const lvl = clamp(percent(data.mq2.lvl));
    $('mq2Lvl').textContent  = `${fmt(lvl)}%`;
    if (typeof data.mq2.v === 'number') $('mq2Volt').textContent = `${data.mq2.v.toFixed(3)} V`;
    if (typeof data.mq2.raw === 'number') $('mq2RawBadge').textContent = `raw: ${data.mq2.raw}`;
    $('mq2Bar').style.width = `${lvl}%`;
  }
  if (data.pot) {
    const pct = clamp(percent(data.pot.pct));
    $('potPct').textContent  = `${fmt(pct)}%`;
    if (typeof data.pot.v === 'number') $('potVolt').textContent = `${data.pot.v.toFixed(3)} V`;
    if (typeof data.pot.raw === 'number') $('potRawBadge').textContent = `raw: ${data.pot.raw}`;
    $('potBar').style.width = `${pct}%`;
  }
  if (data.water) {
    const mode = String(data.water.mode || '').toLowerCase();
    $('waterMode').textContent = `mode: ${mode || 'unknown'}`;
    const analog = $('waterAnalog');
    const digital = $('waterDigital');
    if (mode === 'analog') {
      analog.classList.remove('hidden');
      digital.classList.add('hidden');
      const pct = clamp(percent(data.water.pct));
      $('waterPct').textContent = `${fmt(pct)}%`;
      if (typeof data.water.v === 'number') $('waterVolt').textContent = `${data.water.v.toFixed(3)} V`;
      if (typeof data.water.raw === 'number') $('waterRaw').textContent  = `${data.water.raw}`;
      $('waterBar').style.width = `${pct}%`;
    } else if (mode === 'digital') {
      analog.classList.add('hidden');
      digital.classList.remove('hidden');
      $('waterDO').textContent = (data.water.do === 0 || data.water.do === 1) ? String(data.water.do) : '--';
    }
  }
}

function percent(v) { return (typeof v === 'number') ? v : NaN; }
function clamp(x) {
  if (!(typeof x === 'number')) return 0;
  return Math.max(0, Math.min(100, x));
}
function fmt(x) { return Number.isFinite(x) ? x.toFixed(0) : '--'; }

$('btnConnect').addEventListener('click', connect);
['host','port','path'].forEach(id=>$(id).addEventListener('input', updatePreview));
updatePreview();
$('btnDisconnect').addEventListener('click', () => { if (client) { client.end(true); log('Disconnected'); } });
$('btnClear').addEventListener('click', () => { $('log').textContent = ''; });

// Suggest a default clientId
$('clientId').value = `web-${Math.random().toString(16).slice(2,8)}`;
</script>
</body>
</html>
