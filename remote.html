<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 — MQ2 / POT / DHT11</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{background:linear-gradient(180deg,#0b1224 0%,#0f172a 60%,#111827 100%) fixed;}
  .glass{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px)}
  .card{border-radius:1rem;padding:1rem}
  .pill{display:inline-flex;align-items:center;gap:.5rem;border-radius:9999px;padding:.25rem .75rem;font-size:.875rem}
  .badge{display:inline-block;border-radius:9999px;font-size:.75rem;padding:.125rem .5rem}
  .mono{font-variant-ligatures:none}
  .bar-bg{height:.75rem;border-radius:.75rem;background:rgba(255,255,255,.08)}
  .bar{height:.75rem;border-radius:.75rem;transition:width .25s ease}
</style>
</head>
<body class="text-slate-200">
<div class="max-w-6xl mx-auto p-6">
  <header class="mb-6 flex items-center justify-between">
    <h1 class="text-3xl md:text-4xl font-extrabold"
      style="background:linear-gradient(90deg,#60a5fa,#34d399,#f472b6);-webkit-background-clip:text;background-clip:text;color:transparent">
      ESP32 Dashboard — MQ2 / POT / DHT11</h1>
    <div id="connStatus" class="pill glass">
      <span id="connDot" class="w-2 h-2 rounded-full bg-slate-500"></span>
      <span id="connText">Disconnected</span>
    </div>
  </header>

  <!-- Kết nối -->
  <section class="glass card mb-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div><label class="block text-sm text-slate-400">Broker Host (WSS)</label>
        <input id="host" class="mt-1 w-full rounded-xl px-3 py-2" value="824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud"></div>
      <div><label class="block text-sm text-slate-400">Port</label>
        <input id="port" class="mt-1 w-full rounded-xl px-3 py-2" value="8884"></div>
      <div><label class="block text-sm text-slate-400">Path</label>
        <input id="path" class="mt-1 w-full rounded-xl px-3 py-2" value="/mqtt"></div>

      <div class="md:col-span-3">
        <label class="block text-sm text-slate-400">TLS WebSocket URL (preview)</label>
        <input id="wssPreview" class="mt-1 w-full rounded-xl px-3 py-2 mono" readonly>
      </div>

      <div>
        <label class="block text-sm text-slate-400">Client ID</label>
        <div class="flex gap-3">
          <input id="clientId" class="mt-1 w-full rounded-xl px-3 py-2 mono" placeholder="web-xxxxxx">
          <button class="mt-1 px-3 py-2 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="generateRandomId()">Random</button>
        </div>
      </div>
      <div><label class="block text-sm text-slate-400">Username</label>
        <input id="username" class="mt-1 w-full rounded-xl px-3 py-2" placeholder="your-username" value="admin123"></div>
      <div><label class="block text-sm text-slate-400">Password</label>
        <input id="password" type="password" class="mt-1 w-full rounded-xl px-3 py-2" placeholder="••••••••"></div>

      <div class="md:col-span-2">
        <label class="block text-sm text-slate-400">Subscribe Topic</label>
        <input id="subTopic" class="mt-1 w-full rounded-xl px-3 py-2 mono" value="esp32/sensors">
      </div>
      <div class="flex items-end gap-3">
        <button class="px-4 py-2 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="applyDemo()">Use Demo Broker</button>
        <button class="px-4 py-2 rounded-xl bg-emerald-500 text-black hover:brightness-110" onclick="connect()">Connect</button>
        <button class="px-4 py-2 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="onDisconnect()">Disconnect</button>
      </div>
    </div>
  </section>

  <!-- Cards -->
  <section class="grid md:grid-cols-3 gap-4">
    <!-- MQ-2 -->
    <div class="glass card">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-sky-300">MQ-2 Smoke</h2>
        <span id="mq2Raw" class="badge" style="background:rgba(56,189,248,.2);color:#bae6fd">raw: --</span>
      </div>
      <div class="mt-4">
        <div class="flex items-baseline gap-2">
          <div id="mq2Pct" class="text-3xl font-bold">--%</div>
          <div id="mq2V" class="text-sm text-slate-400">-- V</div>
        </div>
        <div class="bar-bg mt-3"><div id="mq2Bar" class="bar" style="width:0%;background:linear-gradient(90deg,#fb7185,#ef4444)"></div></div>
      </div>
    </div>

    <!-- POT -->
    <div class="glass card">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-emerald-300">Potentiometer</h2>
        <span id="potRaw" class="badge" style="background:rgba(16,185,129,.2);color:#a7f3d0">raw: --</span>
      </div>
      <div class="mt-4">
        <div class="flex items-baseline gap-2">
          <div id="potPct" class="text-3xl font-bold">--%</div>
          <div id="potV" class="text-sm text-slate-400">-- V</div>
        </div>
        <div class="bar-bg mt-3"><div id="potBar" class="bar" style="width:0%;background:linear-gradient(90deg,#34d399,#22c55e)"></div></div>
      </div>
    </div>

    <!-- DHT11 -->
    <div class="glass card">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-indigo-300">DHT11</h2>
        <span id="dhtOk" class="badge" style="background:rgba(99,102,241,.2);color:#c7d2fe">--</span>
      </div>
      <div class="mt-4 grid grid-cols-2 gap-4">
        <div>
          <div class="text-sm text-slate-400">Temperature</div>
          <div id="dhtT" class="text-3xl font-bold">--°C</div>
        </div>
        <div>
          <div class="text-sm text-slate-400">Humidity</div>
          <div id="dhtH" class="text-3xl font-bold">--%</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Console -->
  <section class="glass card mt-6">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-semibold text-slate-300">Console</h3>
      <button class="px-3 py-1 rounded-lg bg-slate-100/10 hover:bg-slate-100/20" onclick="onClear()">Clear</button>
    </div>
    <pre id="log" class="whitespace-pre-wrap text-sm bg-[#0b1224] border border-slate-700 rounded-xl p-3 h-64 overflow-y-auto mono text-slate-300"></pre>
  </section>
</div>

<!-- MQTT.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>

<script>
function $(id){return document.getElementById(id);}
function log(m){const el=$("log");const t=new Date().toLocaleTimeString();el.textContent+="["+t+"] "+m+"\\n";el.scrollTop=el.scrollHeight;}
function setConn(s){const d=$("connDot"),t=$("connText"),p=$("connStatus");p.className="pill glass";d.className="w-2 h-2 rounded-full";
  if(s==="connected"){p.classList.add("bg-emerald-900/40");d.classList.add("bg-emerald-400");t.textContent="Connected";}
  else if(s==="connecting"){p.classList.add("bg-amber-900/40");d.classList.add("bg-amber-400");t.textContent="Connecting...";}
  else if(s==="error"){p.classList.add("bg-red-900/40");d.classList.add("bg-red-400");t.textContent="Error";}
  else{p.classList.add("bg-slate-800/60");d.classList.add("bg-slate-500");t.textContent="Disconnected";}}
function updatePreview(){const h=$("host").value.trim(), po=parseInt($("port").value.trim(),10)||8884, pa=$("path").value.trim()||"/mqtt";$("wssPreview").value=h?`wss://${h}:${po}${pa}`:"";}
function generateRandomId(){$("clientId").value="web-"+Math.random().toString(16).slice(2,8);}
function applyDemo(){$("host").value="broker.hivemq.com";$("port").value="8884";$("path").value="/mqtt";$("username").value="";$("password").value="";$("subTopic").value="test/web/"+Math.random().toString(16).slice(2,6);updatePreview();log("Demo applied");}
function onClear(){$("log").textContent="";}
let client=null;
function connect(){
  updatePreview();
  const host=$("host").value.trim(), port=parseInt($("port").value.trim(),10)||8884, path=$("path").value.trim()||"/mqtt";
  const url=`wss://${host}:${port}${path}`;
  const cid=$("clientId").value.trim()||("web-"+Math.random().toString(16).slice(2,8));
  const user=$("username").value.trim()||undefined, pass=$("password").value||undefined, topic=$("subTopic").value.trim();
  if(!host){alert("Host?");return;}
  if(client){try{client.end(true);}catch(e){}}
  const MQTT = window.mqtt || window.MQTT || mqtt;
  if(!MQTT){setConn("error");log("mqtt lib missing");return;}
  log(`Connecting to ${url} as ${cid} ...`); setConn("connecting");
  client = MQTT.connect(url,{clientId:cid,username:user,password:pass,clean:true,reconnectPeriod:4000,connectTimeout:15000});
  client.on("connect",()=>{setConn("connected"); log("Connected. Subscribing: "+topic); if(topic) client.subscribe(topic);});
  client.on("reconnect",()=>{setConn("connecting"); log("Reconnecting...");});
  client.on("close",()=>{setConn("disconnected"); log("Socket closed");});
  client.on("error",e=>{setConn("error"); log("Error: "+(e?.message||e));});
  client.on("message",(tp,pl)=>{
    let txt; try{txt=new TextDecoder().decode(pl);}catch{txt=String(pl);}
    log(`<= ${tp}: ${txt}`);
    try{const data=JSON.parse(txt); updateUI(data);}catch(e){log("Parse fail: "+e.message);}
  });
}
function onDisconnect(){try{client&&client.end(true);}catch(e){}}

function setPct(id,val){$(id).textContent = (isFinite(val)?Math.max(0,Math.min(100,val)).toFixed(0):"--")+"%";}
function setV(id,v){$(id).textContent = (typeof v==="number") ? v.toFixed(3)+" V" : "-- V";}
function setBar(id,val){$(id).style.width = (isFinite(val)?Math.max(0,Math.min(100,val)):0)+"%";}
function updateUI(d){
  if(d.mq2){ if(typeof d.mq2.raw==="number") $("mq2Raw").textContent="raw: "+d.mq2.raw; setPct("mq2Pct", d.mq2.pct); setV("mq2V", d.mq2.v); setBar("mq2Bar", d.mq2.pct); }
  if(d.pot){ if(typeof d.pot.raw==="number") $("potRaw").textContent="raw: "+d.pot.raw; setPct("potPct", d.pot.pct); setV("potV", d.pot.v); setBar("potBar", d.pot.pct); }
  if(d.dht){ $("dhtOk").textContent = d.dht.ok ? "OK" : "READ FAIL";
             $("dhtT").textContent = (typeof d.dht.t==="number") ? d.dht.t.toFixed(1)+"°C" : "--°C";
             $("dhtH").textContent = (typeof d.dht.h==="number") ? d.dht.h.toFixed(0)+"%"  : "--%"; }
}
// init
(function(){ generateRandomId(); updatePreview(); ["host","port","path"].forEach(id=>$(id).addEventListener("input",updatePreview)); log("[BOOT] page loaded");})();
</script>
</body>
</html>
