<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32 Sensors — MQTT Web Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root { color-scheme: dark }
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial }
  .card{background:rgba(15,23,42,.65);border:1px solid rgba(148,163,184,.15);backdrop-filter:blur(6px)}
  .metric{font-size:clamp(28px,6vw,48px);line-height:1;font-weight:900}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .dot{width:.6rem;height:.6rem;border-radius:999px}
  .bar{height:.75rem;border-radius:.75rem;background:linear-gradient(90deg,#22c55e,#ef4444)}
</style>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen">
<div class="max-w-5xl mx-auto p-5 md:p-8 space-y-6">

  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <h1 class="text-3xl font-black">ESP32 Sensors <span class="text-slate-400 font-bold">/ DHT11 + MQ-2 + Water</span></h1>
    <div id="stateBadge" class="flex items-center gap-2">
      <span id="stateDot" class="dot bg-slate-500"></span>
      <span id="stateText" class="text-sm">Disconnected</span>
    </div>
  </header>

  <!-- Connect -->
  <section class="card rounded-2xl p-4">
    <div class="grid md:grid-cols-6 gap-3">
      <div class="md:col-span-3">
        <label class="text-xs text-slate-400">Broker (host)</label>
        <input id="host" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2"
               value="824c1b62a8bb468fb4d8085acb663caa.s1.eu.hivemq.cloud">
      </div>
      <div>
        <label class="text-xs text-slate-400">Port</label>
        <input id="port" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="8884">
      </div>
      <div>
        <label class="text-xs text-slate-400">Path</label>
        <input id="path" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="/mqtt">
      </div>
      <div>
        <label class="text-xs text-slate-400">Topic</label>
        <input id="topic" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2"
               value="esp32/sensors">
      </div>
      <div>
        <label class="text-xs text-slate-400">Client ID</label>
        <div class="flex gap-2">
          <input id="cid" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2 mono">
          <button class="mt-1 px-3 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="randId()">Rand</button>
        </div>
      </div>
      <div>
        <label class="text-xs text-slate-400">Username</label>
        <input id="user" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" value="admin123">
      </div>
      <div>
        <label class="text-xs text-slate-400">Password</label>
        <input id="pass" type="password" class="w-full mt-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2" placeholder="••••••••">
      </div>
      <div class="md:col-span-2 flex items-end gap-2">
        <input id="wss" class="flex-1 rounded-xl bg-slate-900/60 border border-slate-700 px-3 py-2 mono" readonly>
        <button class="px-4 py-2 rounded-xl bg-emerald-500 text-black font-semibold hover:brightness-110" onclick="connect()">Connect</button>
        <button class="px-4 py-2 rounded-xl bg-slate-100/10 hover:bg-slate-100/20" onclick="disconnect()">Disconnect</button>
      </div>
    </div>
  </section>

  <!-- Cards -->
  <section class="grid md:grid-cols-3 gap-4">
    <!-- MQ-2 -->
    <div class="card rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-sky-300">MQ-2 Smoke</div>
        <span id="mq2Raw" class="text-xs mono px-2 py-1 rounded-full bg-slate-800 border border-slate-700">raw: --</span>
      </div>
      <div class="mt-4">
        <div id="mq2Pct" class="metric">--%</div>
        <div class="mt-3 bg-slate-800 rounded-xl overflow-hidden">
          <div id="mq2Bar" class="bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- Temperature -->
    <div class="card rounded-2xl p-4">
      <div class="font-semibold text-amber-300">Temperature</div>
      <div id="tempVal" class="mt-4 metric">--°C</div>
    </div>

    <!-- Humidity + Water -->
    <div class="card rounded-2xl p-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-indigo-300">Humidity</div>
        <div id="waterBadge" class="flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-slate-800 border border-slate-700">
          <span id="waterDot" class="dot bg-slate-500"></span><span id="waterText">--</span>
        </div>
      </div>
      <div id="humVal" class="mt-4 metric">--%</div>
      <div class="text-xs text-slate-400 mt-2">Water sensor: 0 = CÓ NƯỚC, 1 = KHÔ</div>
    </div>
  </section>

  <!-- Console -->
  <section class="card rounded-2xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Console</div>
      <button class="px-3 py-1 rounded-lg bg-slate-100/10 hover:bg-slate-100/20" onclick="clearLog()">Clear</button>
    </div>
    <pre id="log" class="mono bg-slate-900 border border-slate-800 rounded-xl p-3 h-56 overflow-y-auto text-slate-300"></pre>
  </section>

</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const $ = id => document.getElementById(id);
function log(m){ const el=$('log'); el.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`; el.scrollTop=el.scrollHeight; }
function clearLog(){ $('log').textContent=''; }
function randId(){ $('cid').value = 'web-' + Math.random().toString(16).slice(2,8); }
function updateWSS(){ const host=$('host').value.trim(), port=$('port').value.trim()||'8884', path=$('path').value.trim()||'/mqtt'; $('wss').value = host?`wss://${host}:${port}${path}`:''; }
['host','port','path'].forEach(id=>$(id).addEventListener('input',updateWSS)); randId(); updateWSS();

let client=null;
function setStatus(s){ const dot=$('stateDot'), txt=$('stateText'); dot.className='dot'; if(s==='connected'){dot.classList.add('bg-emerald-400'); txt.textContent='Connected'} else if(s==='connecting'){dot.classList.add('bg-amber-400'); txt.textContent='Connecting...'} else if(s==='error'){dot.classList.add('bg-rose-400'); txt.textContent='Error'} else {dot.classList.add('bg-slate-500'); txt.textContent='Disconnected'} }

function connect(){
  const host=$('host').value.trim(); if(!host){ alert('Nhập broker host'); return; }
  const url=`wss://${host}:${$('port').value.trim()||'8884'}${$('path').value.trim()||'/mqtt'}`;
  const options={
    clientId: $('cid').value.trim() || ('web-'+Math.random().toString(16).slice(2,8)),
    username: $('user').value.trim() || undefined,
    password: $('pass').value || undefined,
    clean: true, reconnectPeriod: 4000, connectTimeout: 15000
  };
  if(client){ try{client.end(true)}catch(e){} }
  log(`Connecting ${url} as ${options.clientId}`);
  setStatus('connecting');
  client = mqtt.connect(url, options);
  client.on('connect', ()=>{
    setStatus('connected'); log('Connected');
    const topic = $('topic').value.trim() || 'esp32/sensors';
    client.subscribe(topic, {qos:0}, (err)=> log(err?('Subscribe error: '+err.message):('Subscribed: '+topic)));
  });
  client.on('message', (topic, payload)=>{
    const text = new TextDecoder().decode(payload);
    log(`<= ${topic}: ${text}`);
    try{ const d = JSON.parse(text); updateUI(d); }catch(e){}
  });
  client.on('reconnect', ()=>{ setStatus('connecting'); log('Reconnecting...'); });
  client.on('close', ()=>{ setStatus('disconnected'); log('Socket closed'); });
  client.on('error', (e)=>{ setStatus('error'); log('Error: '+(e?.message||e)); });
}
function disconnect(){ if(client){ client.end(true); log('Disconnected'); setStatus('disconnected'); } }

// === UPDATE UI for {"t":..., "h":..., "mq2":..., "water":0|1} ===
function updateUI(d){
  if(Number.isFinite(d.mq2)){
    const raw = Math.min(1023, Math.max(0, d.mq2));
    const pct = Math.round(raw/1023*100);
    $('mq2Raw').textContent = 'raw: ' + raw;
    $('mq2Pct').textContent = pct + '%';
    $('mq2Bar').style.width = pct + '%';
  }
  if(Number.isFinite(d.t)) $('tempVal').textContent = d.t.toFixed(1) + '°C';
  if(Number.isFinite(d.h)) $('humVal').textContent  = d.h.toFixed(0) + '%';
  if(typeof d.water !== 'undefined'){
    const dot=$('waterDot'), txt=$('waterText'), badge=$('waterBadge');
    dot.className='dot';
    if(d.water===0){ dot.classList.add('bg-sky-400'); txt.textContent='WET / CÓ NƯỚC'; badge.className='flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-sky-400/10 border border-sky-400/20'; }
    else { dot.classList.add('bg-emerald-400'); txt.textContent='DRY / KHÔ'; badge.className='flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-emerald-400/10 border border-emerald-400/20'; }
  }
}
</script>
</body>
</html>
